{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ product.name }}{% endblock title %}

{% block body %}
<main>
    <section class="py-8 bg-white md:py-16 dark:bg-gray-900 antialiased">
        <div class="max-w-screen-xl px-4 mx-auto 2xl:px-0">
          <div class="lg:grid lg:grid-cols-2 lg:gap-8 xl:gap-16">
            <div class="shrink-0 max-w-md lg:max-w-lg mx-auto">
              <img class="w-full" src="{{ product.image.url }}" alt="" />
            </div>
    
            <div class="mt-6 sm:mt-8 lg:mt-0">
              <h1
                class="text-xl font-semibold text-gray-900 sm:text-2xl dark:text-white"
              >
                {{ product.name | title }}
              </h1>
              <div class="mt-4 sm:items-center sm:gap-4 sm:flex">
                {% if product.price_after_discount %}
                <p class="text-xl line-through">${{ product.price }}</p>
                <p class="text-2xl font-extrabold leading-tight text-gray-900 dark:text-white">${{ product.price_after_discount }}</p>
                {% else %}
                <p class="text-2xl font-extrabold leading-tight text-gray-900 dark:text-white">${{ product.price }}</p>
                {% endif %}
    
                <div class="flex items-center gap-2 mt-2 sm:mt-0">
                  <div class="flex items-center gap-1">
                    {% for i in loop_rating %}
                    {% if i <= product.average_score %}
                        <svg class="h-4 w-4 text-yellow-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13.8 4.2a2 2 0 0 0-3.6 0L8.4 8.4l-4.6.3a2 2 0 0 0-1.1 3.5l3.5 3-1 4.4c-.5 1.7 1.4 3 2.9 2.1l3.9-2.3 3.9 2.3c1.5 1 3.4-.4 3-2.1l-1-4.4 3.4-3a2 2 0 0 0-1.1-3.5l-4.6-.3-1.8-4.2Z" />
                        </svg>
                    {% else %}
                        <svg class="w-4 h-4 text-gray-300 dark:text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 22 20">
                            <path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"></path>
                        </svg>
                    {% endif %}
                    {% endfor %}
                  </div>
                  <p
                    class="text-sm font-medium leading-none text-gray-500 dark:text-gray-400"
                  >
                    ({{ product.average_score|floatformat:1 }})
                  </p>
                  <a
                    class="text-sm font-medium leading-none text-gray-900 underline dark:text-white"
                  >
                  {{ product.comments.count }} Comments
                  </a>
                </div>
              </div>
    
              <div class="mt-6 sm:gap-4 sm:items-center sm:flex sm:mt-8">
                <a
                  id="add_favorites"
                  onclick="add_favorites()"
                  title=""
                  class="{% if request.user in product.likes.all %}hidden{% endif %} flex items-center justify-center py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700"
                  role="button"
                >
                  <svg
                    class="w-5 h-5 -ms-2 me-2"
                    aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12.01 6.001C6.5 1 1 8 5.782 13.001L12.011 20l6.23-7C23 8 17.5 1 12.01 6.002Z"
                    />
                  </svg>                     
                  Add to favorites
                </a>
                <a
                  id="remove_favorites"
                  onclick="remove_favorites()"
                  title=""
                  class="{% if request.user not in product.likes.all %}hidden{% else %}flex{% endif %} items-center justify-center py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:hover:bg-gray-800 dark:hover:text-gray-400 dark:border-gray-600 dark:text-white dark:bg-gray-700"
                  role="button"
                >
                  <svg class="w-5 h-5 -ms-2 me-2 text-rose-700" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path d="m12.75 20.66 6.184-7.098c2.677-2.884 2.559-6.506.754-8.705-.898-1.095-2.206-1.816-3.72-1.855-1.293-.034-2.652.43-3.963 1.442-1.315-1.012-2.678-1.476-3.973-1.442-1.515.04-2.825.76-3.724 1.855-1.806 2.201-1.915 5.823.772 8.706l6.183 7.097c.19.216.46.34.743.34a.985.985 0 0 0 .743-.34Z"/>
                  </svg>                      
                  Remove from favorites
                </a>
                
                {% if request.user.is_authenticated %}
                <a
                id="add-cart"
                onclick="add_cart()"
                class="{% if quantity %}hidden{% endif %} text-white mt-4 sm:mt-0 bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-primary-600 dark:hover:bg-primary-700 focus:outline-none dark:focus:ring-primary-800 flex items-center justify-center"
                  role="button"
                  >
                  <svg
                    class="w-5 h-5 -ms-2 me-2"
                    aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 4h1.5L8 16m0 0h8m-8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm.75-3H7.5M11 7H6.312M17 4v6m-3-3h6"
                    />
                  </svg>
    
                  Add to cart
                </a>
                <div class="relative {% if not quantity %}hidden {% else %}flex{% endif %} mx-auto md:mx-0 mt-4 md:mt-0 items-center max-w-[8rem]" id="quantity-counter">
                  <button type="button" id="decrement-button" data-input-counter-decrement="quantity-input" class="bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:border-gray-600 hover:bg-gray-200 border border-gray-300 rounded-s-lg p-3 h-11 focus:ring-gray-100 dark:focus:ring-gray-700 focus:ring-2 focus:outline-none">
                    <svg class="w-3 h-3 text-gray-900 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 2">
                          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h16"/>
                        </svg>
                  </button>
                  <input id="quantityProduct" type="text" id="quantity-input" data-input-counter data-input-counter-min="1" data-input-counter-max="5" aria-describedby="helper-text-explanation" class="bg-gray-50 border-x-0 border-gray-300 h-11 text-center text-gray-900 text-sm focus:ring-blue-500 focus:border-blue-500 block w-full py-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" value="{{ quantity }}" required />
                  <button type="button" id="increment-button" data-input-counter-increment="quantity-input" class="bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:border-gray-600 hover:bg-gray-200 border border-gray-300 rounded-e-lg p-3 h-11 focus:ring-gray-100 dark:focus:ring-gray-700 focus:ring-2 focus:outline-none">
                      <svg class="w-3 h-3 text-gray-900 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
                      </svg>
                    </button>
                  </div>
                {% else %}
                <a
                id="add-cart"
                href="{% url "account:login" %}"
                class="text-white mt-4 sm:mt-0 bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-primary-600 dark:hover:bg-primary-700 focus:outline-none dark:focus:ring-primary-800 flex items-center justify-center"
                  role="button"
                  >
                  <svg
                    class="w-5 h-5 -ms-2 me-2"
                    aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 4h1.5L8 16m0 0h8m-8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm.75-3H7.5M11 7H6.312M17 4v6m-3-3h6"
                    />
                  </svg>
    
                  Add to cart (Need Login)
                </a>
                {% endif %}
              </div>
    
              <hr class="my-6 md:my-8 border-gray-200 dark:border-gray-800" />
    
              <p class="mb-6 text-gray-500 dark:text-gray-400">
                {{ product.description }}
              </p>
            </div>
          </div>
        </div>
      </section>
      <section class="bg-white dark:bg-gray-900 py-8 lg:py-16 antialiased">
        <div class="max-w-2xl mx-auto px-4">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-lg lg:text-2xl font-bold text-gray-900 dark:text-white">Comments ({{ product.comments.count }})</h2>
          </div>
          <form class="mb-6" id="comment-form">
            
            <input type="hidden" name="rating" id="rating-value">
            
            <div class="py-2 px-4 mb-4 bg-white rounded-lg rounded-t-lg border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
              <label for="comment" class="sr-only">Your comment</label>
              <textarea id="comment" rows="6" class="px-0 w-full text-sm text-gray-900 border-0 focus:ring-0 focus:outline-none dark:text-white dark:placeholder-gray-400 dark:bg-gray-800" placeholder="Write a comment..." required></textarea>
            </div>
            <div class="flex items-center space-x-1 my-5">
                <button type="button" class="star-button" data-star="1">
                    <svg aria-hidden="true" class="w-8 h-8 text-gray-400 hover:text-yellow-400" fill="currentColor"
                        viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.147 3.53a1 1 0 00.95.69h3.705c.969 0 1.371 1.24.588 1.81l-2.997 2.18a1 1 0 00-.364 1.118l1.146 3.53c.3.92-.755 1.688-1.54 1.118l-2.996-2.18a1 1 0 00-1.176 0l-2.996 2.18c-.785.57-1.84-.198-1.54-1.118l1.146-3.53a1 1 0 00-.364-1.118L2.68 8.957c-.783-.57-.38-1.81.588-1.81h3.705a1 1 0 00.95-.69l1.147-3.53z" />
                    </svg>
                </button>
                <button type="button" class="star-button" data-star="2">
                    <svg aria-hidden="true" class="w-8 h-8 text-gray-400 hover:text-yellow-400" fill="currentColor"
                        viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.147 3.53a1 1 0 00.95.69h3.705c.969 0 1.371 1.24.588 1.81l-2.997 2.18a1 1 0 00-.364 1.118l1.146 3.53c.3.92-.755 1.688-1.54 1.118l-2.996-2.18a1 1 0 00-1.176 0l-2.996 2.18c-.785.57-1.84-.198-1.54-1.118l1.146-3.53a1 1 0 00-.364-1.118L2.68 8.957c-.783-.57-.38-1.81.588-1.81h3.705a1 1 0 00.95-.69l1.147-3.53z" />
                    </svg>
                </button>
                <button type="button" class="star-button" data-star="3">
                    <svg aria-hidden="true" class="w-8 h-8 text-gray-400 hover:text-yellow-400" fill="currentColor"
                        viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.147 3.53a1 1 0 00.95.69h3.705c.969 0 1.371 1.24.588 1.81l-2.997 2.18a1 1 0 00-.364 1.118l1.146 3.53c.3.92-.755 1.688-1.54 1.118l-2.996-2.18a1 1 0 00-1.176 0l-2.996 2.18c-.785.57-1.84-.198-1.54-1.118l1.146-3.53a1 1 0 00-.364-1.118L2.68 8.957c-.783-.57-.38-1.81.588-1.81h3.705a1 1 0 00.95-.69l1.147-3.53z" />
                    </svg>
                </button>
                <button type="button" class="star-button" data-star="4">
                    <svg aria-hidden="true" class="w-8 h-8 text-gray-400 hover:text-yellow-400" fill="currentColor"
                        viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.147 3.53a1 1 0 00.95.69h3.705c.969 0 1.371 1.24.588 1.81l-2.997 2.18a1 1 0 00-.364 1.118l1.146 3.53c.3.92-.755 1.688-1.54 1.118l-2.996-2.18a1 1 0 00-1.176 0l-2.996 2.18c-.785.57-1.84-.198-1.54-1.118l1.146-3.53a1 1 0 00-.364-1.118L2.68 8.957c-.783-.57-.38-1.81.588-1.81h3.705a1 1 0 00.95-.69l1.147-3.53z" />
                    </svg>
                </button>
                <button type="button" class="star-button" data-star="5">
                    <svg aria-hidden="true" class="w-8 h-8 text-gray-400 hover:text-yellow-400" fill="currentColor"
                        viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.147 3.53a1 1 0 00.95.69h3.705c.969 0 1.371 1.24.588 1.81l-2.997 2.18a1 1 0 00-.364 1.118l1.146 3.53c.3.92-.755 1.688-1.54 1.118l-2.996-2.18a1 1 0 00-1.176 0l-2.996 2.18c-.785.57-1.84-.198-1.54-1.118l1.146-3.53a1 1 0 00-.364-1.118L2.68 8.957c-.783-.57-.38-1.81.588-1.81h3.705a1 1 0 00.95-.69l1.147-3.53z" />
                    </svg>
                </button>
            </div>
        
            <button type="submit" class="inline-flex items-center py-2.5 px-4 text-xs font-medium text-center text-white bg-primary-700 rounded-lg focus:ring-4 focus:ring-primary-200 dark:focus:ring-primary-900 hover:bg-primary-800">
                Submit comment
            </button>
        </form>
        {% for comment in product.comments.all %}
        <article class="p-6 text-base bg-white rounded-lg dark:bg-gray-900">
            <footer class="flex justify-between items-center mb-2">
                <div class="flex items-center">
                    <p class="inline-flex items-center mr-3 text-sm text-gray-900 dark:text-white font-semibold">{% if comment.user.full_name %}{{ comment.user.full_name }}{% else %}{{ comment.user.email }}{% endif %}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400"><time pubdate datetime="2022-02-08"
                            title="February 8th, 2022">{{ comment.created_at | naturaltime }}</time></p>
                </div>
                <div class="flex items-center mb-1 space-x-1 rtl:space-x-reverse">
                    {% for i in loop_rating %}
                    {% if i <= comment.score %}
                        <svg class="h-4 w-4 text-yellow-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13.8 4.2a2 2 0 0 0-3.6 0L8.4 8.4l-4.6.3a2 2 0 0 0-1.1 3.5l3.5 3-1 4.4c-.5 1.7 1.4 3 2.9 2.1l3.9-2.3 3.9 2.3c1.5 1 3.4-.4 3-2.1l-1-4.4 3.4-3a2 2 0 0 0-1.1-3.5l-4.6-.3-1.8-4.2Z" />
                        </svg>
                    {% else %}
                        <svg class="w-4 h-4 text-gray-300 dark:text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 22 20">
                            <path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"></path>
                        </svg>
                    {% endif %}
                    {% endfor %}
                </div>
            </footer>
            <p class="text-gray-500 dark:text-gray-400">{{ comment.comment }}</p>
        </article>
        {% endfor %}

        </div>
      </section>
</main>
{% endblock body %}

{% block script-section %}
<script>
let like_element = document.getElementById("add_favorites");
let liked_element = document.getElementById("remove_favorites");
let product_slug = "{{ product.slug }}";

function remove_favorites() {
  unlikeProduct(product_slug);
  like_element.style.display = "flex";
  liked_element.style.display = "none";
}
function add_favorites() {
  likeProduct(product_slug);
  like_element.style.display = "none";
  liked_element.style.display = "flex";
}

function likeProduct(productSlug) {
  fetch(`/api/products/${productSlug}/like/`, {
      method: "POST",
      headers: {
          "X-CSRFToken": getCookie("csrftoken"),
      },
  })
  .then((response) => {
      if (response.ok) {
      } else {
          throw new Error("Failed to like the product");
      }
  })
  .catch((error) => {
      console.error(error);
  });
}

function unlikeProduct(productSlug) {
  fetch(`/api/products/${productSlug}/like/`, {
      method: "DELETE",
      headers: {
          "X-CSRFToken": getCookie("csrftoken"),
      },
  })
  .then((response) => {
      if (response.ok) {
      } else {
          throw new Error("Failed to unlike the product");
      }
  })
  .catch((error) => {
      console.error(error);
  });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + "=")) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}

async function add_to_cart() {
  try {
    const url = `/api/products/${product_slug}/cart/`;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || 'Error updating cart');
    }

    return true;
} catch (error) {
    console.error('Cart update failed:', error);
    alert(error.message);
    return false;
}
}
async function reduce_from_cart() {
  try {
      const url = `/api/products/${product_slug}/cart/`;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      const response = await fetch(url, {
          method: 'DELETE',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
          },
      });

      if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || 'Error updating cart');
      }

      return true;
  } catch (error) {
      console.error('Cart update failed:', error);
      alert(error.message);
      return false;
  }
}
const decrementButton = document.querySelector('[data-input-counter-decrement="quantity-input"]');
const incrementButton = document.querySelector('[data-input-counter-increment="quantity-input"]');
const quantityInput = document.getElementById('quantityProduct');

const addCart = document.getElementById('add-cart');
const quantityCounter = document.getElementById('quantity-counter');
    
function add_cart() {
    quantityInput.value = 1;
    addCart.style.display = "none";
    quantityCounter.style.display = "flex";
    add_to_cart();
}

incrementButton.addEventListener('click', function() {
    const newQuantity = parseInt(quantityInput.value);
    quantityInput.value++;
    disableControls();
    add_to_cart();
    enableControls();
});

decrementButton.addEventListener('click', function() {
    const newQuantity = parseInt(quantityInput.value);
    quantityInput.value--;
    disableControls();
    if (newQuantity <= 1) {
        reduce_from_cart();
        removeFromCart();
    } else {
      reduce_from_cart();
    }
    enableControls();
});

function disableControls() {
    decrementButton.disabled = true;
    incrementButton.disabled = true;
    quantityInput.disabled = true;
}

function enableControls() {
    decrementButton.disabled = false;
    incrementButton.disabled = false;
    quantityInput.disabled = false;
}


function removeFromCart() {
    quantityInput.value = 0;
    addCart.style.display = "flex";
    quantityCounter.style.display = "none";
    enableControls();
}

// star
const stars = document.querySelectorAll('.star-button');
const ratingValue = document.getElementById('rating-value');

stars.forEach((star, index) => {
star.addEventListener('click', () => {
    ratingValue.value = star.getAttribute('data-star');
    stars.forEach((s, i) => {
        s.querySelector('svg').classList.remove('text-yellow-400');
        s.querySelector('svg').classList.add('text-gray-400');
        if (i <= index) {
            s.querySelector('svg').classList.remove('text-gray-400');
            s.querySelector('svg').classList.add('text-yellow-400');
        }
    });
});
});

document.getElementById('comment-form').addEventListener('submit', (e) => {
e.preventDefault();

const comment = document.getElementById('comment').value;
const rating = ratingValue.value;

if (!rating) {
    alert('Please select a rating!');
    return;
}

if (!comment) {
    alert('Please write a comment!');
    return;
}

const formData = new FormData();
formData.append('rating', rating);
formData.append('comment', comment);

});
</script>
{% endblock script-section %}